name: CI - Module Validation (Gradual Rollout)

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'domain/**'
      - 'application/**'
      - 'adapter-in/**'
      - 'adapter-out/**'
      - 'bootstrap/**'
  workflow_dispatch:
    inputs:
      module:
        description: 'Module to validate (domain, application, adapter-in:rest-api, etc.)'
        required: true
        type: choice
        options:
          - all
          - domain
          - application
          - adapter-in:rest-api
          - adapter-out:persistence-mysql
          - adapter-out:client-aws-s3
          - adapter-out:client-aws-sqs
          - bootstrap:bootstrap-web-api
          - bootstrap:bootstrap-scheduler

jobs:
  # ========================================
  # Detect Changed Modules
  # ========================================
  detect-changes:
    name: Detect Changed Modules
    runs-on: ubuntu-latest
    outputs:
      domain: ${{ steps.filter.outputs.domain }}
      application: ${{ steps.filter.outputs.application }}
      adapter-in-rest: ${{ steps.filter.outputs.adapter-in-rest }}
      adapter-out-mysql: ${{ steps.filter.outputs.adapter-out-mysql }}
      adapter-out-s3: ${{ steps.filter.outputs.adapter-out-s3 }}
      adapter-out-sqs: ${{ steps.filter.outputs.adapter-out-sqs }}
      bootstrap-web: ${{ steps.filter.outputs.bootstrap-web }}
      bootstrap-scheduler: ${{ steps.filter.outputs.bootstrap-scheduler }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect module changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            domain:
              - 'domain/**'
            application:
              - 'application/**'
            adapter-in-rest:
              - 'adapter-in/rest-api/**'
            adapter-out-mysql:
              - 'adapter-out/persistence-mysql/**'
            adapter-out-s3:
              - 'adapter-out/client-aws-s3/**'
            adapter-out-sqs:
              - 'adapter-out/client-aws-sqs/**'
            bootstrap-web:
              - 'bootstrap/bootstrap-web-api/**'
            bootstrap-scheduler:
              - 'bootstrap/bootstrap-scheduler/**'

  # ========================================
  # Validate Domain Module
  # ========================================
  validate-domain:
    name: Validate Domain Module
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.domain == 'true' ||
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.module == 'domain' || github.event.inputs.module == 'all')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Domain Module
        run: ./gradlew :domain:build

      - name: Test Domain Module
        run: ./gradlew :domain:test

      - name: Run Domain ArchUnit Tests
        run: ./gradlew :domain:test --tests "*ArchitectureTest" --tests "*ConventionTest"

      - name: Domain Module Summary
        if: success()
        run: |
          echo "✅ Domain Module Validation PASSED"
          echo "  - Build: Success"
          echo "  - Tests: Success"
          echo "  - ArchUnit: Success"

  # ========================================
  # Validate Application Module
  # ========================================
  validate-application:
    name: Validate Application Module
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.application == 'true' ||
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.module == 'application' || github.event.inputs.module == 'all')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Application Module
        run: ./gradlew :application:build

      - name: Test Application Module
        run: ./gradlew :application:test

      - name: Run Application ArchUnit Tests
        run: ./gradlew :application:test --tests "*ArchitectureTest" --tests "*ConventionTest"

      - name: Application Module Summary
        if: success()
        run: |
          echo "✅ Application Module Validation PASSED"
          echo "  - Build: Success"
          echo "  - Tests: Success"
          echo "  - ArchUnit: Success"

  # ========================================
  # Validate Adapter-In (REST API) Module
  # ========================================
  validate-adapter-in-rest:
    name: Validate REST API Module
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.adapter-in-rest == 'true' ||
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.module == 'adapter-in:rest-api' || github.event.inputs.module == 'all')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build REST API Module
        run: ./gradlew :adapter-in:rest-api:build

      - name: Test REST API Module
        run: ./gradlew :adapter-in:rest-api:test

      - name: Run REST API ArchUnit Tests
        run: ./gradlew :adapter-in:rest-api:test --tests "*ArchitectureTest" --tests "*ConventionTest"

      - name: REST API Module Summary
        if: success()
        run: |
          echo "✅ REST API Module Validation PASSED"
          echo "  - Build: Success"
          echo "  - Tests: Success"
          echo "  - ArchUnit: Success"

  # ========================================
  # Validate Adapter-Out (Persistence MySQL) Module
  # ========================================
  validate-adapter-out-mysql:
    name: Validate Persistence MySQL Module
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.adapter-out-mysql == 'true' ||
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.module == 'adapter-out:persistence-mysql' || github.event.inputs.module == 'all')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Persistence MySQL Module
        run: ./gradlew :adapter-out:persistence-mysql:build

      - name: Test Persistence MySQL Module
        run: ./gradlew :adapter-out:persistence-mysql:test

      - name: Run Persistence MySQL ArchUnit Tests
        run: ./gradlew :adapter-out:persistence-mysql:test --tests "*ArchitectureTest" --tests "*ConventionTest"

      - name: Persistence MySQL Module Summary
        if: success()
        run: |
          echo "✅ Persistence MySQL Module Validation PASSED"
          echo "  - Build: Success"
          echo "  - Tests: Success"
          echo "  - ArchUnit: Success"

  # ========================================
  # Validation Summary
  # ========================================
  validation-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs:
      - detect-changes
      - validate-domain
      - validate-application
      - validate-adapter-in-rest
      - validate-adapter-out-mysql
    if: always()

    steps:
      - name: Summary
        run: |
          echo "========================================="
          echo "Module Validation Summary"
          echo "========================================="
          echo "Domain: ${{ needs.validate-domain.result || 'skipped' }}"
          echo "Application: ${{ needs.validate-application.result || 'skipped' }}"
          echo "REST API: ${{ needs.validate-adapter-in-rest.result || 'skipped' }}"
          echo "Persistence MySQL: ${{ needs.validate-adapter-out-mysql.result || 'skipped' }}"
          echo "========================================="

          # Check if any validation failed
          if [[ "${{ needs.validate-domain.result }}" == "failure" ]] || \
             [[ "${{ needs.validate-application.result }}" == "failure" ]] || \
             [[ "${{ needs.validate-adapter-in-rest.result }}" == "failure" ]] || \
             [[ "${{ needs.validate-adapter-out-mysql.result }}" == "failure" ]]; then
            echo "❌ Module Validation FAILED"
            exit 1
          else
            echo "✅ All changed modules passed validation"
          fi
